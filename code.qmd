---
title: "code"
format: html
editor: visual
---

# Chargement des librairies

```{r}
#juliette
library(readr)
library(tsoutliers)
library(forecast)
library(rAmCharts)
library(smooth)

#isaline
library(tseries)      
library(moments)
library(fBasics)
library(tibble)
library(ggplot2)
library(RJDemetra)
```

# Import des donn√©es

```{r}
y <- read_csv("data.csv")
```

# Cr√©ation de la ts

```{r}
yy <- ts(y$APU000072610, start=c(2000,01),frequency=12)
```

# 1) Analyse exploratoire

## a) Pr√©sentation et caract√©risation de la s√©rie √©tudi√©e : source, d√©finition, graphique

```{r}
plot.ts(yy, main = "Prix de l'√©lectricit√© moyen (par kW/h) des villes aux Etats_Unis (2000-2020)", ylab = "Prix", xlab = "Ann√©e")
```

## b) D√©tection des points atypiques. Pr√©senter ces points sous forme de tableau (date, type de point (AO, TC ...), t-stat) et trouver des explications √©conomiques de l'apparition des 3 plus importants

```{r}
# Automoatic procedure for detection of outliers
fit <- tso(yy)
plot(fit)
show(fit)
```

2 points atypiques d√©tect√©s :
Outliers:
  type ind    time   coefhat  tstat
1   LS  73 2006:01  0.004563  5.229
2   AO 172 2014:04 -0.004166 -6.790

Explication √©conomique :

1. Level Shift (LS) en janvier 2006 (2006:01) ‚Äì Coef : +0.004563
Ce que √ßa signifie : √Ä partir de janvier 2006, il y a eu une hausse durable du niveau des prix de l‚Äô√©lectricit√© dans les villes am√©ricaines. Ce n‚Äôest pas juste une fluctuation, mais un changement de r√©gime, une "cassure de tendance".

Hypoth√®ses √©conomiques possibles :

üìà Hausse du co√ªt des combustibles fossiles utilis√©s dans la production d‚Äô√©lectricit√© (charbon, gaz naturel).

‚öôÔ∏è R√©formes dans le march√© de l‚Äô√©lectricit√© : par exemple, d√©r√©glementation dans certains √âtats qui a conduit √† des hausses de prix.

üå± D√©but de politiques √©nerg√©tiques en faveur des √©nergies renouvelables, augmentant les co√ªts de transition pour les fournisseurs.

üîå Investissements dans les infrastructures √©lectriques (grilles intelligentes, s√©curit√©, maintenance‚Ä¶) r√©percut√©s sur les consommateurs.

üîé √Ä noter : entre 2005 et 2006, les prix du gaz naturel ont fortement augment√© aux √âtats-Unis (surtout apr√®s les ouragans Katrina et Rita en 2005), ce qui a probablement entra√Æn√© une hausse durable des prix de l‚Äô√©lectricit√©.

üìå 2. Additive Outlier (AO) en octobre 2014 (2014:04) ‚Äì Coef : -0.004166
Ce que √ßa signifie : En octobre 2014, il y a eu une baisse ponctuelle du prix moyen de l‚Äô√©lectricit√©. La s√©rie reprend son cours normal ensuite, donc ce n‚Äôest pas un changement structurel.

Hypoth√®ses √©conomiques possibles :

üõ¢Ô∏è Chute brutale des prix du p√©trole en 2014, qui a aussi impact√© les prix du gaz naturel (souvent utilis√© pour produire de l‚Äô√©lectricit√©). Cela a pu provoquer une baisse temporaire des prix de l‚Äô√©lectricit√©.

üåÄ Conditions climatiques exceptionnelles qui auraient r√©duit la consommation ou permis une production plus efficace.

üßæ Subventions temporaires ou politiques locales limitant les tarifs pendant une courte p√©riode.

üìâ Le prix du p√©trole a commenc√© √† chuter fortement √† la mi-2014, ce qui a eu des r√©percussions sur de nombreuses formes d‚Äô√©nergie.



```{r}
# outlier adjusted series
adj <- fit$yadj
plot(adj)
write(t(adj), file="adjusted-series.out", ncolumn = 1, append = FALSE)

tso(adj)
```
Il n'y a plus de points atypiques. 

## c) Statistiques descriptives sur la s√©rie corrig√©e (moyenne, √©cart-type, skewness, kurtosis normalit√©, box-plot ...). Commenter

### Statistiques descriptives

```{r}
stat = basicStats(adj)
show(stat)
```

Pour commencer, nous observons que la moyenne et la m√©diane sont relativement proches, ce qui montre une bonne distribution des valeurs. N√©anmoins, la m√©diane est l√©g√®rement sup√©rieure √† la moyenne, ce qui laisse penser qu'il y a tout de m√™me une certaine asym√©trie.  De plus, l'√©cart type √©tant faible, cela indique que les valeurs sont faiblement dispers√©es autour de la moyenne et que les prix sont plut√¥t stable.

Ensuite, la Skewness √©tant n√©gative, de -0.5538, cela confirme la pr√©sence d'une l√©g√®re asym√©trie √† gauche. Alors, la plupart des valeurs sont √©lev√©es, cependant quelques valeurs faibles tirent la moyenne vers le bas.

En ce qui concerne le Kurtosis, nous trouvons un chiffre largement inf√©rieur √† 3 : la distribution est platycurtique. Ainsi, il y a peu de pics de valeurs extr√™mes sur cette p√©riode.

### Box-plot

```{r}
df <- tibble(value = as.numeric(adj))
ggplot(
  df, aes(y = value)) +
  geom_boxplot(fill = "royalblue", alpha = 0.5) +
  labs(title = "Boxplot de la s√©rie corrig√©e", y = "Valeur") +
  theme_minimal()
```

La s√©rie ne montre pas de potentielles valeurs atypiques.

## d) D√©tection de la saisonnalit√© et sch√©ma de d√©composition (additif ou multiplicatif)

```{r}
myregx13 <- regarima_x13(adj, spec ="RG5c")
summary(myregx13)
s_transform(myregx13)
plot(myregx13)
```

Test log level (vers slide 20) => pas de transformation en log => sch√©ma et d√©composition additive

# 2) D√©saisonnalisation et d√©composition

## D√©saisonnaliser et d√©composer la s√©rie corrig√©e √† partir des m√©thodes X13-ARIMA SEATS. Commenter (effets d√©terministes, param√®tres ARIMA ...)

```{r}
myspec <- x13_spec("RSA5c")
mysax13 <- x13(adj, myspec)
summary(mysax13$regarima)
mysax13
plot(mysax13$final)

y_lin(mysats)


data('dat_stock_2')
```

Mod√®le ARIMA saisonnier avec :

-  Diff√©rence non saisonni√®re (d=1) ‚Üí il faut diff√©rencier la s√©rie une fois pour la rendre stationnaire (tendance pr√©sente).

-  Diff√©rence saisonni√®re (D=1) ‚Üí il faut aussi la diff√©rencier sur 12 mois pour corriger les effets saisonniers.

-  MA saisonnier (Q=1) ‚Üí il y a une composante bruit blanc √† corriger chaque ann√©e (mensualit√©).

BTheta(1)  -0.8452

Cycle        27.3%
Seasonal     69.6%
Irregular     1.9%
Tr√®s faible ‚Üí mod√®le capte bien la dynamique de la s√©rie. Peu de variance inexpliqu√©e.

La saisonnalit√© explique pr√®s de 70% de la variance (hors tendance). Cela indique que les prix de l‚Äô√©lectricit√© suivent une forte dynamique saisonni√®re ‚Äî typiquement li√©e :
-  √Ä la climatisation l‚Äô√©t√© 
-  Au chauffage l‚Äôhiver 

Tous les tests de r√©sidu saisonnier sont > 0.9, donc :
-  Pas de saisonnalit√© r√©siduelle : le mod√®le a bien nettoy√© les effets saisonniers.
-  Pas de preuve de saisonnalit√© instable sur la p√©riode.

Conclusion : 
Les prix de l‚Äô√©lectricit√© sont tr√®s saisonniers (‚âà70 % de la variance).

Il y a une tendance sous-jacente mod√©r√©e mais bien pr√©sente.

Pas de bruit al√©atoire important ‚Üí bonne pr√©visibilit√©.

Le mod√®le est tr√®s propre statistiquement : pas de r√©sidu suspect, pas d‚Äôinstabilit√©.

# 3) Pr√©vision de la s√©rie saisonni√®re corrig√©e des points atypiques sur une ann√©e

## a) Estimer et pr√©voir les mod√®les suivants :

### (i) les m√©thodes Na√Øve, X13-ARIMA-SEATS, STL et STS. Commenter les mod√®les STS (variance : level, slope, seas, epsilon)

#### X13-ARIMA-SEATS

```{r}
myregx13$forecast
myregx13$model$effects
myregx13$residuals
myregx13$residuals.stat
```

#### STL

est-ce qu'il y a besoin de faire la d√©comp de stl?? prcq dans la question c'est seulement demand√© de commenter les STS donc de d√©comp sts
```{r}
decomp <- stl(adj, s.window = "periodic")
plot(decomp)
```

```{r}
fitstl = stlm(adj)
prevstl <- forecast(fitstl,12) # 12 dans le td
show(prevstl)
plot(prevstl)
```

#### STS

```{r}
fit <- StructTS(adj)
plot(cbind(fitted(fit), residuals(fit)))
show(fit)
```

```{r}
fitsts = StructTS(adj)
prevsts <- forecast(fitsts,12) # aussi 12 dans le td
show(prevsts)
plot(prevsts)
```

En observant les variances du mod√®le STS, nous trouvons que le mod√®le est globalement stable et pr√©visible.
Pour commencer, la variance sur le niveau (level) est nulle, signifiant que le niveau est constant dans le temps.

Ensuite, la variance de la pente (slope) est tr√®s faible, montrant une √©volution lente de la tendance sur la p√©riode √©tudi√©e.

Apr√®s cela, la saisonnalit√© (seas) est r√©guli√®re, avec une variance √©galement tr√®s faible.

Enfin, il n'y a aucune variance sur les erreurs r√©siduelles, alors, nous pouvons d√©duire que le mod√®le explique tr√®s bien la s√©rie.


### (ii) les m√©thodes de lissage exponentiel : Holt-Winters, ETS, TBATS, ADAM ETS, ADAM ETS SARIMA et SSARIMA. Commenter ces mod√®les.

#### Holt-Winters
```{r}
# --- Seasonal HW ---
# Holt-Winters additif :
m <- HoltWinters(adj,seasonal="add")
m

# horizon h=50 - intervals 95%
p = predict(m, 50, prediction.interval = TRUE) 
plot(m, p)
show(p)
prevp = p[1]
show(prevp)
```
Smoothing parameters:
 alpha: 0.8872126
 beta : 0.02022757
 gamma: 1
 
 
#### ETS
```{r}
# Estimate ETS methods with forecast package
# ETS: Error, Trend, Seasonal
fitets <- ets(adj)
show(fitets)
plot(fitets)

# Forecasting: 12-ahead forecasts
prevets <- forecast(fitets,12)
show(prevets)
plot(prevets)

```
Smoothing parameters:
    alpha = 0.4316 
    beta  = 0.1454 
    gamma = 0.3338 
    phi   = 0.9759 

      AIC      AICc       BIC 
-1928.384 -1925.303 -1865.657 

#### TBATS
```{r}
# Estimate seasonal decomposition with forecast package
# TBATS model: Exponential smoothing state space model with Box-Cox transformation, 
# ARMA errors, Trend and Seasonal components

decomp <- tbats(adj)
show(decomp)
plot(decomp)

# Forecasting: 12-ahead forecasts
prevtbats <- forecast(decomp,12)
show(prevtbats)
plot(prevtbats)
```

Parameters
  Alpha: 0.9851542
  Beta: -0.01946547
  Damping Parameter: 0.990434
  Gamma-1 Values: -0.0003006371
  Gamma-2 Values: 0.001320002
  
Sigma: 0.000911622
AIC: -2018.301

#### ADAM ETS
```{r}
fitadam1 <- auto.adam(adj, model="ZZZ", lags=c(1,12), select=TRUE)
show(fitadam1)
plot(fitadam1)

# Forecasting: 12-ahead forecasts
# ADAM ETS
prevadam1 <- forecast(fitadam1,12)
show(prevadam1)
plot(prevadam1)
```
alpha 
    1 
    
Information criteria:
      AIC      AICc       BIC      BICc 
-2745.733 -2745.564 -2731.794 -2731.329

#### ADAM ETS SARIMA
```{r}
fitadam2 <- auto.adam(adj, model="ZZZ", lags=c(1,1,12), orders=list(ar=c(3,3), i=(2), ma=c(3,3), select=TRUE))
show(fitadam2)
plot(fitadam2)

# ADAM ETS+ARIMA
prevadam2 <- forecast(fitadam2, h=12, level = 0.90)
prevadam2
plot(prevadam2)
```
alpha 
    1 
    
Information criteria:
      AIC      AICc       BIC      BICc 
-2745.733 -2745.564 -2731.794 -2731.329

### SSARIMA
```{r}
# SSARIMA
fitssarima <- auto.ssarima(adj, lags=c(1,12), orders=list(ar=c(3,3), i=(2), ma=c(3,3), select=TRUE))
fitssarima
summary(fitssarima)

par(mfcol=c(2,2))
plot(fitssarima)

# Forecasting: 12-ahead forecasts
prevssarima <- forecast(fitssarima, h=12, level = 0.90)
prevssarima
plot(prevssarima)

par(mfcol=c(2,2))
```
Model estimated: SARIMA(3,1,3)[1](3,0,0)[12]

Information criteria:
      AIC      AICc       BIC      BICc 
-2638.685 -2637.729 -2603.837 -2601.214 

### (iii) un mod√®le SARIMA(p,d,q)(P,D,Q)12 . Commenter ce mod√®le.

```{r}
fit_sarima <- auto.arima(adj, seasonal = TRUE)

summary(fit_sarima)
```


## b) Param√®tres : pr√©senter sous forme de tableau les param√®tres des mod√®les pr√©c√©dents. D√©terminer et commenter le meilleur mod√®le d'apr√®s les crit√®res AIC et AICc

```{r}

```

# 4) Repr√©senter graphiquement l'√©volution des pr√©visions des diff√©rents mod√®les et commenter.

```{r}

```

# 5) Qualit√© de pr√©vision : calculer les MSE et R2OOS de tous les mod√®les pr√©c√©dents (3a) et d√©finir le meilleur mod√®le. Comparer les √† celles d'une pr√©vision na√Øve. Faire √©galement le graphique des CSPE.

```{r}

```

# 6) Test de pr√©cision : calculer le test de Diebold-Mariano pour chaque mod√®le par rapport √†

la pr√©vision na√Øve et d√©finir le meilleur mod√®le (option ¬´ less ¬ª)

```{r}

```

# 7) Pr√©vision sur une ann√©e avec un pas de 1 mois avec le meilleur mod√®le de la question 6)

```{r}

```
